<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>リアルタイムピアノ音楽生成</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.39/Tone.min.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <h1>ピアノ音楽生成アプリ</h1>
    <label for="velocity">音量:</label>
    <input type="range" id="velocity" min="0" max="1" step="0.1" value="0.5">
    <span id="velocity-value">0.5</span>
    
    <label for="tempo">テンポ:</label>
    <input type="number" id="tempo" min="60" max="540" value="240">

    <label for="melodyRange">メロディ幅:</label>
    <select id="melodyRange">
        <option value="1" selected>1</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
    </select>

    <div class="control-group">
        <h3>音符 / 休符 の長さ</h3>
        <div class="control-item">
            <label for="duration">複雑度:</label>
            <input type="range" id="duration" min="0" max="100" step="5" value="50">
            <span id="duration-value">50</span>
        </div>
        
        <div class="control-item">
            <label for="rest">休符を含める:</label>
            <input type="checkbox" id="rest" checked>
        </div>
        
        <div class="control-item">
            <label for="restProbability">休符の確率:</label>
            <input type="range" id="restProbability" min="10" max="50" step="5" value="25">
            <span id="restProbability-value">25%</span>
        </div>
    </div>

    <button id="playButton" disabled>音楽を再生</button>
    <button id="stopButton">停止</button>

    <script>
        let isPlaying = false;
        let intervalId; // インターバルIDを保持する変数

        // 各音階に対応するピアノサンプルをTone.Bufferで読み込む
        const pianos = {
            "A0": new Tone.Buffer("assets/acoustic_grand_piano-mp3/A0.mp3"),
            "A1": new Tone.Buffer("assets/acoustic_grand_piano-mp3/A1.mp3"),
            "A2": new Tone.Buffer("assets/acoustic_grand_piano-mp3/A2.mp3"),
            "A3": new Tone.Buffer("assets/acoustic_grand_piano-mp3/A3.mp3"),
            "A4": new Tone.Buffer("assets/acoustic_grand_piano-mp3/A4.mp3"),
            "A5": new Tone.Buffer("assets/acoustic_grand_piano-mp3/A5.mp3"),
            "A6": new Tone.Buffer("assets/acoustic_grand_piano-mp3/A6.mp3"),
            "A7": new Tone.Buffer("assets/acoustic_grand_piano-mp3/A7.mp3"),
            "A#0": new Tone.Buffer("assets/acoustic_grand_piano-mp3/Bb0.mp3"),
            "A#1": new Tone.Buffer("assets/acoustic_grand_piano-mp3/Bb1.mp3"),
            "A#2": new Tone.Buffer("assets/acoustic_grand_piano-mp3/Bb2.mp3"),
            "A#3": new Tone.Buffer("assets/acoustic_grand_piano-mp3/Bb3.mp3"),
            "A#4": new Tone.Buffer("assets/acoustic_grand_piano-mp3/Bb4.mp3"),
            "A#5": new Tone.Buffer("assets/acoustic_grand_piano-mp3/Bb5.mp3"),
            "A#6": new Tone.Buffer("assets/acoustic_grand_piano-mp3/Bb6.mp3"),
            "A#7": new Tone.Buffer("assets/acoustic_grand_piano-mp3/Bb7.mp3"),
            "B0": new Tone.Buffer("assets/acoustic_grand_piano-mp3/B0.mp3"),
            "B1": new Tone.Buffer("assets/acoustic_grand_piano-mp3/B1.mp3"),
            "B2": new Tone.Buffer("assets/acoustic_grand_piano-mp3/B2.mp3"),
            "B3": new Tone.Buffer("assets/acoustic_grand_piano-mp3/B3.mp3"),
            "B4": new Tone.Buffer("assets/acoustic_grand_piano-mp3/B4.mp3"),
            "B5": new Tone.Buffer("assets/acoustic_grand_piano-mp3/B5.mp3"),
            "B6": new Tone.Buffer("assets/acoustic_grand_piano-mp3/B6.mp3"),
            "B7": new Tone.Buffer("assets/acoustic_grand_piano-mp3/B7.mp3"),
            "C1": new Tone.Buffer("assets/acoustic_grand_piano-mp3/C1.mp3"),
            "C2": new Tone.Buffer("assets/acoustic_grand_piano-mp3/C2.mp3"),
            "C3": new Tone.Buffer("assets/acoustic_grand_piano-mp3/C3.mp3"),
            "C4": new Tone.Buffer("assets/acoustic_grand_piano-mp3/C4.mp3"),
            "C5": new Tone.Buffer("assets/acoustic_grand_piano-mp3/C5.mp3"),
            "C6": new Tone.Buffer("assets/acoustic_grand_piano-mp3/C6.mp3"),
            "C7": new Tone.Buffer("assets/acoustic_grand_piano-mp3/C7.mp3"),
            "C#1": new Tone.Buffer("assets/acoustic_grand_piano-mp3/Db1.mp3"),
            "C#2": new Tone.Buffer("assets/acoustic_grand_piano-mp3/Db2.mp3"),
            "C#3": new Tone.Buffer("assets/acoustic_grand_piano-mp3/Db3.mp3"),
            "C#4": new Tone.Buffer("assets/acoustic_grand_piano-mp3/Db4.mp3"),
            "C#5": new Tone.Buffer("assets/acoustic_grand_piano-mp3/Db5.mp3"),
            "C#6": new Tone.Buffer("assets/acoustic_grand_piano-mp3/Db6.mp3"),
            "C#7": new Tone.Buffer("assets/acoustic_grand_piano-mp3/Db7.mp3"),
            "D1": new Tone.Buffer("assets/acoustic_grand_piano-mp3/D1.mp3"),
            "D2": new Tone.Buffer("assets/acoustic_grand_piano-mp3/D2.mp3"),
            "D3": new Tone.Buffer("assets/acoustic_grand_piano-mp3/D3.mp3"),
            "D4": new Tone.Buffer("assets/acoustic_grand_piano-mp3/D4.mp3"),
            "D5": new Tone.Buffer("assets/acoustic_grand_piano-mp3/D5.mp3"),
            "D6": new Tone.Buffer("assets/acoustic_grand_piano-mp3/D6.mp3"),
            "D7": new Tone.Buffer("assets/acoustic_grand_piano-mp3/D7.mp3"),
            "D#1": new Tone.Buffer("assets/acoustic_grand_piano-mp3/Eb1.mp3"),
            "D#2": new Tone.Buffer("assets/acoustic_grand_piano-mp3/Eb2.mp3"),
            "D#3": new Tone.Buffer("assets/acoustic_grand_piano-mp3/Eb3.mp3"),
            "D#4": new Tone.Buffer("assets/acoustic_grand_piano-mp3/Eb4.mp3"),
            "D#5": new Tone.Buffer("assets/acoustic_grand_piano-mp3/Eb5.mp3"),
            "D#6": new Tone.Buffer("assets/acoustic_grand_piano-mp3/Eb6.mp3"),
            "D#7": new Tone.Buffer("assets/acoustic_grand_piano-mp3/Eb7.mp3"),
            "E1": new Tone.Buffer("assets/acoustic_grand_piano-mp3/E1.mp3"),
            "E2": new Tone.Buffer("assets/acoustic_grand_piano-mp3/E2.mp3"),
            "E3": new Tone.Buffer("assets/acoustic_grand_piano-mp3/E3.mp3"),
            "E4": new Tone.Buffer("assets/acoustic_grand_piano-mp3/E4.mp3"),
            "E5": new Tone.Buffer("assets/acoustic_grand_piano-mp3/E5.mp3"),
            "E6": new Tone.Buffer("assets/acoustic_grand_piano-mp3/E6.mp3"),
            "E7": new Tone.Buffer("assets/acoustic_grand_piano-mp3/E7.mp3"),
            "F1": new Tone.Buffer("assets/acoustic_grand_piano-mp3/F1.mp3"),
            "F2": new Tone.Buffer("assets/acoustic_grand_piano-mp3/F2.mp3"),
            "F3": new Tone.Buffer("assets/acoustic_grand_piano-mp3/F3.mp3"),
            "F4": new Tone.Buffer("assets/acoustic_grand_piano-mp3/F4.mp3"),
            "F5": new Tone.Buffer("assets/acoustic_grand_piano-mp3/F5.mp3"),
            "F6": new Tone.Buffer("assets/acoustic_grand_piano-mp3/F6.mp3"),
            "F7": new Tone.Buffer("assets/acoustic_grand_piano-mp3/F7.mp3"),
            "F#1": new Tone.Buffer("assets/acoustic_grand_piano-mp3/Gb1.mp3"),
            "F#2": new Tone.Buffer("assets/acoustic_grand_piano-mp3/Gb2.mp3"),
            "F#3": new Tone.Buffer("assets/acoustic_grand_piano-mp3/Gb3.mp3"),
            "F#4": new Tone.Buffer("assets/acoustic_grand_piano-mp3/Gb4.mp3"),
            "F#5": new Tone.Buffer("assets/acoustic_grand_piano-mp3/Gb5.mp3"),
            "F#6": new Tone.Buffer("assets/acoustic_grand_piano-mp3/Gb6.mp3"),
            "F#7": new Tone.Buffer("assets/acoustic_grand_piano-mp3/Gb7.mp3"),
            "G1": new Tone.Buffer("assets/acoustic_grand_piano-mp3/G1.mp3"),
            "G2": new Tone.Buffer("assets/acoustic_grand_piano-mp3/G2.mp3"),
            "G3": new Tone.Buffer("assets/acoustic_grand_piano-mp3/G3.mp3"),
            "G4": new Tone.Buffer("assets/acoustic_grand_piano-mp3/G4.mp3"),
            "G5": new Tone.Buffer("assets/acoustic_grand_piano-mp3/G5.mp3"),
            "G6": new Tone.Buffer("assets/acoustic_grand_piano-mp3/G6.mp3"),
            "G7": new Tone.Buffer("assets/acoustic_grand_piano-mp3/G7.mp3"),
            "G#1": new Tone.Buffer("assets/acoustic_grand_piano-mp3/Ab1.mp3"),
            "G#2": new Tone.Buffer("assets/acoustic_grand_piano-mp3/Ab2.mp3"),
            "G#3": new Tone.Buffer("assets/acoustic_grand_piano-mp3/Ab3.mp3"),
            "G#4": new Tone.Buffer("assets/acoustic_grand_piano-mp3/Ab4.mp3"),
            "G#5": new Tone.Buffer("assets/acoustic_grand_piano-mp3/Ab5.mp3"),
            "G#6": new Tone.Buffer("assets/acoustic_grand_piano-mp3/Ab6.mp3"),
            "G#7": new Tone.Buffer("assets/acoustic_grand_piano-mp3/Ab7.mp3"),
        };

        // Tone.Samplerにピアノサンプルをセット
        const pianoSampler = new Tone.Sampler(pianos).toDestination();

        // サンプルのロード完了を待つ
        Tone.loaded().then(() => {
            console.log("All samples are loaded");
            document.getElementById('playButton').disabled = false;  // ロード完了後にボタンを有効にする
        });

        // 音楽生成ロジックをクライアントサイドに移動
        function generateNewSequence() {
            const notes = Array.from({length: 12}, (_, i) => i + 60);
            return notes.sort(() => Math.random() - 0.5);
        }

        function retrograde(row) {
            return [...row].reverse();
        }

        function inversion(row) {
            const baseNote = row[0];
            const inverted = row.map(note => baseNote - (note - baseNote));
            return inverted.map(note => ((note - 60 + 12) % 12) + 60);
        }

        let melodyRow = [];
        let baseRow = [];
        let rowRetro = [];
        let rowInverted = [];
        let rowRetroInverted = [];
        let sequenceIndex = 0;
        let octave_shift = 0;
        let isRandomOctave = false;

        // オクターブシフトを計算する関数を追加
        function calculateOctaveShift(melodyRange) {
            if (melodyRange === 1) return 0;
            const range = melodyRange - 1;  // 片側の範囲
            return Math.floor(Math.random() * (range * 2 + 1)) - range;
        }

        // 音符の長さを決定する関数
        // complexity: 複雑度 (0-100)
        // 戻り値: 音符の長さを表す文字列 ('2n', '4n', '8n', '16n')
        //
        // 複雑度に応じて以下の確率分布で音符の長さを決定:
        // 0%: 4分音符のみ (4n: 100%)
        // 25%: 4分音符中心 + 8分音符導入 (4n: 75%, 8n: 25%)
        // 50%: 4分音符と8分音符が均等 (4n: 50%, 8n: 50%)
        // 75%: 2分音符と16分音符を導入 (2n: 12.5%, 4n: 37.5%, 8n: 37.5%, 16n: 12.5%)
        // 100%: すべて均等 (2n: 25%, 4n: 25%, 8n: 25%, 16n: 25%)
        // 
        // 中間値は線形補間で確率を計算
        function getNoteDuration(complexity) {
            // 音符の長さの定義（Tone.jsの表記）
            const durations = {
                '2n': '2分音符',
                '4n': '4分音符',
                '8n': '8分音符',
                '16n': '16分音符'
            };

            // 複雑度に応じた確率分布を計算
            let probabilities = {};
            
            if (complexity <= 0) {
                probabilities = { '4n': 1 };
            } else if (complexity <= 25) {
                const ratio = complexity / 25;
                probabilities = {
                    '4n': 0.75 + (0.25 * (1 - ratio)),
                    '8n': 0.25 * ratio
                };
            } else if (complexity <= 50) {
                const ratio = (complexity - 25) / 25;
                probabilities = {
                    '4n': 0.75 - (0.25 * ratio),
                    '8n': 0.25 + (0.25 * ratio)
                };
            } else if (complexity <= 75) {
                const ratio = (complexity - 50) / 25;
                probabilities = {
                    '2n': 0.125 * ratio,
                    '4n': 0.5 - (0.125 * ratio),
                    '8n': 0.5 - (0.125 * ratio),
                    '16n': 0.125 * ratio
                };
            } else {
                const ratio = (complexity - 75) / 25;
                probabilities = {
                    '2n': 0.125 + (0.125 * ratio),
                    '4n': 0.375 - (0.125 * ratio),
                    '8n': 0.375 - (0.125 * ratio),
                    '16n': 0.125 + (0.125 * ratio)
                };
            }

            // 確率に基づいて音符の長さを選択
            const random = Math.random();
            let accumulator = 0;
            
            for (const [duration, probability] of Object.entries(probabilities)) {
                accumulator += probability;
                if (random <= accumulator) {
                    return duration;
                }
            }
            
            return '4n'; // デフォルトは4分音符
        }

        function getDurationInMilliseconds(duration, tempo) {
            const durationMap = {
                '2n': 2,
                '4n': 1,
                '8n': 0.5,
                '16n': 0.25
            };
            
            const beats = durationMap[duration] || 1;
            return (60000 / tempo) * beats;
        }

        function generateNextNote(velocity, tempo, melodyRange) {
            if (!melodyRow.length || sequenceIndex >= melodyRow.length) {
                if (!melodyRow.length || Math.random() < 0.25) {
                    baseRow = generateNewSequence();
                    rowRetro = retrograde(baseRow);
                    rowInverted = inversion(baseRow);
                    rowRetroInverted = retrograde(rowInverted);
                }
                melodyRow = [baseRow, rowRetro, rowInverted, rowRetroInverted][Math.floor(Math.random() * 4)];
                sequenceIndex = 0;
                
                // 75%の確率で12音共通のoctave_shiftを設定
                isRandomOctave = Math.random() < 0.25;  // 25%の確率でtrue
                if (!isRandomOctave) {
                    octave_shift = calculateOctaveShift(melodyRange);
                }
            }

            // 25%の確率で音ごとに個別のoctave_shiftを計算
            let currentOctaveShift = octave_shift;
            if (isRandomOctave) {
                currentOctaveShift = calculateOctaveShift(melodyRange);
            }

            const note = melodyRow[sequenceIndex] + (currentOctaveShift * 12);
            sequenceIndex++;

            // velocityを指定された値から-0.1〜+0.1の範囲でランダムに調整
            const adjustedVelocity = velocity + (Math.random() * 0.2 - 0.1);
            // tempoを指定された値から-10%〜+10%の範囲でランダムに調整
            const adjustedTempo = tempo + (tempo * 0.1 * (Math.random() * 2 - 1));
            
            // 複雑度を取得
            const complexity = parseInt(document.getElementById('duration').value);
            
            return {
                note: note,
                duration: getNoteDuration(complexity),
                velocity: adjustedVelocity,
                tempo: adjustedTempo
            };
        }

        document.getElementById('playButton').addEventListener('click', async () => {
            if (!isPlaying) {
                await Tone.start();
                isPlaying = true;
                
                function playNextNote() {
                    const velocity = parseFloat(document.getElementById('velocity').value);
                    const tempo = parseInt(document.getElementById('tempo').value);
                    const melodyRange = parseInt(document.getElementById('melodyRange').value);
                    const includeRest = document.getElementById('rest').checked;
                    
                    // 休符を含める設定がオンの場合、設定された確率で休符を挿入
                    if (includeRest) {
                        const restProb = parseInt(document.getElementById('restProbability').value) / 100;
                        if (Math.random() < restProb) {
                            const complexity = parseInt(document.getElementById('duration').value);
                            const restDuration = getNoteDuration(complexity);
                            const interval = getDurationInMilliseconds(restDuration, tempo);
                            
                            clearInterval(intervalId);
                            intervalId = setInterval(playNextNote, interval);
                            return;
                        }
                    }
                    
                    const musicData = generateNextNote(velocity, tempo, melodyRange);
                    
                    pianoSampler.triggerAttackRelease(
                        Tone.Frequency(musicData.note, "midi").toNote(), 
                        musicData.duration, 
                        undefined, 
                        musicData.velocity
                    );
                    
                    Tone.Transport.bpm.value = musicData.tempo;

                    clearInterval(intervalId);
                    const interval = getDurationInMilliseconds(musicData.duration, musicData.tempo);
                    intervalId = setInterval(playNextNote, interval);
                }

                playNextNote();
            }
        });

        document.getElementById('stopButton').addEventListener('click', () => {
            if (isPlaying) {
                clearInterval(intervalId);
                isPlaying = false;
            }
        });

        document.getElementById('velocity').addEventListener('input', function(e) {
            document.getElementById('velocity-value').textContent = e.target.value;
        });

        document.getElementById('duration').addEventListener('input', function(e) {
            document.getElementById('duration-value').textContent = e.target.value;
        });

        document.getElementById('restProbability').addEventListener('input', function(e) {
            document.getElementById('restProbability-value').textContent = e.target.value + '%';
        });
    </script>
</body>
</html>
